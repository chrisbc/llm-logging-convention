# Agent Instructions

This file provides context for AI assistants (Claude, OpenCode, Cursor, etc.) working on this project.

## LLM Session Logging

When working on this project, **always append a log entry** to `.llm/log.jsonl` at the end of each session.

### Log Schema

```json
{
  "timestamp": "2025-02-22T10:30:00Z",
  "session_start": "2025-02-22T09:15:00Z",
  "project_name": "NutBot CityLimit",
  "project_root": "nutbot-citylimit",
  "model": "claude-3-5-sonnet",
  "tool": "claude-code | opencode | cursor | other",
  "duration_min": 25,
  "tokens_in": 15000,
  "tokens_out": 8000,
  "commits": ["e263c5e", "abc1234"],
  "files": {
    "read": ["PLAN.md", "TRACTOR.md"],
    "created": ["README.md", "tractor/MOTOR_CONTROLLER.md"],
    "modified": ["README.md"]
  },
  "summary": "Brief description of work done",
  "user_notes": "Optional notes from user"
}
```

### Field Definitions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `timestamp` | ISO 8601 string | Yes | When the log entry was created (UTC) |
| `session_start` | ISO 8601 string | No | When this work segment began (UTC) |
| `project_name` | string | Yes | Human-readable project name |
| `project_root` | string | Yes | Root folder name (for aggregation) |
| `model` | string | Yes | Model identifier |
| `tool` | string | Yes | Tool name (claude-code, opencode, cursor, etc.) |
| `duration_min` | number | No | Duration of this work segment in minutes |
| `tokens_in` | number | No | Input tokens used |
| `tokens_out` | number | No | Output tokens generated |
| `commits` | string[] | No | Git commit hashes made during this segment |
| `files` | object | No | File operations categorized |
| `files.read` | string[] | No | Files read/referenced |
| `files.created` | string[] | No | New files created |
| `files.modified` | string[] | No | Existing files modified |
| `summary` | string | Yes | Brief description of session work |
| `user_notes` | string | No | Optional user-provided notes |

### Data Accuracy

Not all fields are equally reliable. LLM agents typically don't have direct access to their own session metadata, so some values are best-effort estimates:

- **Always precise**: `timestamp` (via `date -u`), `model`, `tool`, `commits`, `files`, `summary`
- **Precise if valid session file**: `session_start`, `duration_min`
- **Estimated**: `tokens_in`/`tokens_out`

### Implementation Notes

- **Append only**: Each session adds one line, never modify existing entries
- **JSONL format**: One valid JSON object per line (no trailing commas, no array wrapper)
- **Always use Bash `>>`**: LLM tools' Write and Edit commands overwrite file contents. Always use `printf '%s\n' '{...}' >> .llm/log.jsonl` via Bash to append
- **File path**: Always `.llm/log.jsonl` in project root
- **Create if missing**: `mkdir -p .llm` before appending if the directory doesn't exist

## /log-start Command

### Usage

```
/log-start [topic]
```

**Purpose**: Mark the start of a work session. Records timestamp and optional topic to `.llm/.session` for later use by `/log`.

### Behavior

1. **Check for existing session** — if `.llm/.session` exists:
   - Check for unlogged commits since that `start` time
   - If commits found, prompt: "Previous session has unlogged commits. Log it first? [y/n]"
   - `y` → run `/log`, then continue; `n` → warn and overwrite

2. **Write session file** using bash with live UTC timestamp:
   ```bash
   echo "{\"start\":\"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\",\"topic\":\"<topic>\"}" > .llm/.session
   ```

3. Confirm: "Session started: *<topic>*" (or just "Session started." if no topic)

**Notes**: `.llm/.session` is transient and should be in `.gitignore`.

## /log Command

### Usage

```
/log [notes]
```

**Purpose**: Log a work segment. Creates an entry in `.llm/log.jsonl` and updates `.session.start` for the next segment.

### Behavior

When user invokes `/log`:

1. **Get current timestamp** using bash:
   ```bash
   date -u +"%Y-%m-%dT%H:%M:%SZ"
   ```

2. **Check for session file** (`.llm/.session`):

   **If file does NOT exist:**
   - Ask user: "No session file found. Provide a session_start time? (YYYY-MM-DDTHH:MM:SSZ or 'skip')"

   **If file EXISTS:**
   - Read `start` and `topic` from `.llm/.session`

3. **Calculate duration** (if valid `session_start`):
   ```bash
   now=$(date -u +%s)
   start_epoch=$(TZ=UTC date -j -f "%Y-%m-%dT%H:%M:%SZ" "$start" +%s 2>/dev/null || TZ=UTC date -d "$start" +%s 2>/dev/null)
   echo $(( (now - start_epoch) / 60 ))
   ```

4. **Threshold check** — if `duration_min > 120`:
   - Prompt: "Session shows **X hours** duration. Adjust start time? [y/no/abort]"
   - `y`: Ask "Enter new start (YYYY-MM-DDTHH:MM:SSZ or 'now'):"
     - `now` → use current timestamp, `duration_min` = 0
     - timestamp → validate and use, recalculate duration
   - `no`: Proceed with current duration (legitimate long session)
   - `abort`: Cancel `/log` command

5. **Find commits**: `git log --since="<session_start>"` or `--since="<last_log_timestamp>"`

6. **If no notes provided**: Ask "Add any notes for this log entry? (press Enter to skip)"

7. **Append entry** to `.llm/log.jsonl`:
   ```bash
   mkdir -p .llm && printf '%s\n' '{"timestamp":"...","project_name":"..."}' >> .llm/log.jsonl
   ```

8. **Update `.session.start`** to the log entry timestamp:
   ```bash
   echo "{\"start\":\"$timestamp\",\"topic\":\"$topic\"}" > .llm/.session
   ```

9. **Confirm**: "Logged session to .llm/log.jsonl"

### Notes Field

The `user_notes` field captures:
- Key decisions made
- Blockers encountered
- Next steps identified
- Any other context the user wants preserved

### Example Log Entry

```json
{"timestamp":"2025-02-22T10:30:00Z","session_start":"2025-02-22T09:15:00Z","project_name":"Your Project Name","project_root":"your-project-root","model":"claude-3-5-sonnet","tool":"opencode","duration_min":25,"commits":["e263c5e"],"files":{"read":["PLAN.md","TRACTOR.md"],"created":["README.md"],"modified":[]},"summary":"Add project README and initial docs","user_notes":""}
```

## Project Context

- **Project**: [Your project name]
- **Description**: [Brief description]
- **Key docs**: [List important documentation files]